<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bot de Descargas</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #17212B;
            --bg-primary: #232E3C;
            --bg-card: #2B3945;
            --bg-input: #1C2733;
            --text-primary: #FFFFFF;
            --text-secondary: #8B9AA5;
            --text-muted: #708499;
            --accent-blue: #2AABEE;
            --accent-green: #6DC26D;
            --accent-red: #E55B5B;
            --accent-orange: #E5A958;
            --accent-purple: #9B7BEA;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            padding-bottom: 100px;
            margin: 0 auto;
        }

        /* Responsive container */
        @media (min-width: 768px) {
            .container {
                padding: 24px;
                padding-bottom: 120px;
            }
        }

        @media (min-width: 1024px) {
            .container {
                max-width: 800px;
                padding: 32px 24px;
                padding-bottom: 120px;
            }
        }

        @media (min-width: 1280px) {
            .container {
                max-width: 900px;
            }
        }

        /* ========== ONBOARDING ========== */
        .onboarding {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .onboarding-slides {
            flex: 1;
            display: flex;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .onboarding-slide {
            min-width: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            text-align: center;
        }

        .onboarding-icon {
            font-size: 80px;
            margin-bottom: 30px;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .onboarding-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .onboarding-desc {
            font-size: 15px;
            color: var(--text-primary); /* Fix: Ensure text is always white */
            line-height: 1.5;
            max-width: 280px;
        }

        .onboarding-footer {
            padding: 20px 30px 40px;
        }

        .onboarding-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--bg-card);
            transition: all 0.3s;
        }

        .dot.active {
            width: 24px;
            border-radius: 4px;
            background: var(--accent-blue);
        }

        .onboarding-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: var(--accent-blue);
            color: white;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
        }

        .onboarding-skip {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            margin-top: 12px;
            width: 100%;
        }

        /* ========== HEADER ========== */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 4px 16px;
        }

        .app-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-blue), #1E96D1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .app-title {
            font-size: 17px;
            font-weight: 700;
        }

        .app-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .user-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--accent-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== BOTTOM NAV ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--bg-card);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 11px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: var(--accent-blue);
        }

        .nav-item .nav-icon {
            font-size: 22px;
        }

        /* ========== CARDS ========== */
        .card {
            background: var(--bg-primary);
            border-radius: 20px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        /* Responsive card spacing */
        @media (min-width: 768px) {
            .card {
                border-radius: 24px;
                margin-bottom: 20px;
            }
        }

        @media (min-width: 1024px) {
            .card {
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 24px;
            }
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--bg-card);
        }

        @media (min-width: 768px) {
            .card-header {
                padding: 18px 24px;
            }
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (min-width: 768px) {
            .card-title {
                font-size: 16px;
            }
        }

        .card-body {
            padding: 20px;
        }

        @media (min-width: 768px) {
            .card-body {
                padding: 24px;
            }
        }

        /* ========== TABS ========== */
        .tab-panel {
            display: none;
            animation: fadeIn 0.25s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== TAB: INICIO ========== */
        .welcome-banner {
            background: linear-gradient(135deg, rgba(42, 171, 238, 0.15), rgba(42, 171, 238, 0.05));
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            text-align: center;
        }

        .welcome-emoji {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .welcome-text {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .welcome-hint {
            font-size: 12px;
            color: var(--text-muted);
        }

        .download-box {
            position: relative;
        }

        .download-input {
            width: 100%;
            padding: 16px 54px 16px 16px;
            border: 2px solid var(--bg-card);
            border-radius: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .download-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .download-input::placeholder {
            color: var(--text-muted);
        }

        .download-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 42px;
            height: 42px;
            border: none;
            border-radius: 12px;
            background: var(--accent-blue);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .download-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .download-btn:disabled {
            background: var(--bg-card);
            cursor: not-allowed;
        }

        .download-status {
            margin-top: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            font-size: 13px;
            display: none;
        }

        .download-status.show { display: flex; align-items: center; gap: 10px; }
        .download-status.loading { background: rgba(42, 171, 238, 0.1); color: var(--accent-blue); }
        .download-status.success { background: rgba(109, 194, 109, 0.1); color: var(--accent-green); }
        .download-status.error { background: rgba(229, 91, 91, 0.1); color: var(--accent-red); }

        .action-btns {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:active {
            opacity: 0.8;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .quick-stat {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
        }

        .quick-stat-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .quick-stat-value {
            font-size: 18px;
            font-weight: 700;
        }

        .quick-stat-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Premium Banner */
        .premium-mini {
            background: linear-gradient(135deg, #E5A958 0%, #F0C987 100%);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .premium-mini-icon {
            font-size: 28px;
        }

        .premium-mini-text {
            flex: 1;
        }

        .premium-mini-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .premium-mini-desc {
            font-size: 11px;
            color: #4a4a4a;
        }

        .premium-mini-arrow {
            font-size: 18px;
            color: #1a1a1a;
        }

        /* ========== TAB: PREMIUM ========== */
        .premium-hero {
            text-align: center;
            padding: 24px 16px;
            background: linear-gradient(180deg, rgba(229, 169, 88, 0.15), transparent);
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .premium-crown {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .premium-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .premium-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Comparison Table */
        .compare-table {
            margin-bottom: 16px;
        }

        .compare-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-card);
        }

        .compare-row:last-child {
            border-bottom: none;
        }

        .compare-feature {
            flex: 1;
            font-size: 13px;
        }

        .compare-free, .compare-premium {
            width: 60px;
            text-align: center;
            font-size: 13px;
        }

        .compare-header {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 11px;
        }

        .compare-check {
            color: var(--accent-green);
        }

        .compare-x {
            color: var(--accent-red);
        }

        .compare-value {
            color: var(--text-secondary);
        }

        .compare-value.gold {
            color: var(--accent-orange);
            font-weight: 600;
        }

        /* Price */
        .price-card {
            background: linear-gradient(135deg, var(--accent-orange), #F0C987);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .price-amount {
            font-size: 42px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .price-star {
            font-size: 28px;
        }

        .price-period {
            font-size: 14px;
            color: #4a4a4a;
            margin-top: 4px;
        }

        .buy-button {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-blue), #1E96D1);
            color: white;
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(42, 171, 238, 0.3);
            position: relative;
            overflow: hidden;
        }

        .buy-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .buy-button:hover::before {
            left: 100%;
        }

        .buy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42, 171, 238, 0.4);
        }

        .buy-button:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 8px rgba(42, 171, 238, 0.3);
        }

        .buy-button:disabled {
            background: var(--bg-card);
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.5;
        }

        /* Responsive button sizes */
        @media (min-width: 768px) {
            .buy-button {
                padding: 18px 32px;
                font-size: 17px;
                border-radius: 18px;
            }
        }

        @media (min-width: 1024px) {
            .buy-button {
                padding: 20px 40px;
                font-size: 18px;
            }
        }

        /* ========== PREMIUM PLAN CARDS ========== */
        .plan-card {
            background: var(--bg-primary);
            border-radius: 20px;
            margin-top: 16px;
            overflow: visible;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .plan-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .plan-card.featured {
            border-width: 2px;
            box-shadow: 0 4px 16px rgba(42, 171, 238, 0.2);
        }

        .plan-card.featured:hover {
            box-shadow: 0 8px 32px rgba(42, 171, 238, 0.3);
        }

        .plan-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            letter-spacing: 0.5px;
        }

        @media (min-width: 768px) {
            .plan-badge {
                font-size: 12px;
                padding: 7px 20px;
            }
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .plan-info h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        @media (min-width: 768px) {
            .plan-info h3 {
                font-size: 22px;
            }
        }

        .plan-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        @media (min-width: 768px) {
            .plan-desc {
                font-size: 14px;
            }
        }

        .plan-price {
            text-align: right;
        }

        .plan-price-main {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @media (min-width: 768px) {
            .plan-price-main {
                font-size: 32px;
            }
        }

        .plan-price-star {
            font-size: 20px;
        }

        @media (min-width: 768px) {
            .plan-price-star {
                font-size: 22px;
            }
        }

        .plan-price-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .plan-savings {
            background: rgba(229, 165, 88, 0.15);
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 16px;
            text-align: center;
        }

        @media (min-width: 768px) {
            .plan-savings {
                padding: 12px;
            }
        }

        .referral-bonus-card {
            background: linear-gradient(135deg, rgba(42, 171, 238, 0.1), rgba(155, 123, 234, 0.1));
            border: 1px solid rgba(42, 171, 238, 0.2);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .referral-bonus-card {
                padding: 24px;
            }
        }

        .referral-bonus-btn {
            margin-top: 14px;
            padding: 10px 20px;
            background: rgba(42, 171, 238, 0.2);
            border: none;
            border-radius: 12px;
            color: var(--accent-blue);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .referral-bonus-btn:hover {
            background: rgba(42, 171, 238, 0.3);
            transform: scale(1.05);
        }

        @media (min-width: 768px) {
            .referral-bonus-btn {
                padding: 12px 24px;
                font-size: 14px;
            }
        }

        /* Premium Active */
        .premium-active {
            text-align: center;
            padding: 30px 16px;
        }

        @media (min-width: 768px) {
            .premium-active {
                padding: 40px 24px;
            }
        }

        .premium-active-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(229, 169, 88, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--accent-orange);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .premium-active-days {
            font-size: 64px;
            font-weight: 700;
            color: var(--accent-orange);
        }

        .premium-active-text {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* ========== TAB: CUENTA ========== */
        .account-card {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
        }

        .account-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
        }

        .account-icon.connected {
            background: rgba(109, 194, 109, 0.15);
        }

        .account-icon.disconnected {
            background: rgba(229, 91, 91, 0.15);
        }

        .account-info h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .account-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .account-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .account-btn.primary {
            background: var(--accent-blue);
            color: white;
        }

        .account-btn.danger {
            background: rgba(229, 91, 91, 0.15);
            color: var(--accent-red);
        }

        .account-btn:active {
            transform: scale(0.98);
        }

        /* Limits */
        .limit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--bg-card);
        }

        .limit-item:last-child {
            border-bottom: none;
        }

        .limit-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .limit-info {
            flex: 1;
        }

        .limit-name {
            font-size: 14px;
            font-weight: 500;
        }

        .limit-bar {
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .limit-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .limit-fill.blue { background: var(--accent-blue); }
        .limit-fill.green { background: var(--accent-green); }
        .limit-fill.orange { background: var(--accent-orange); }
        .limit-fill.purple { background: var(--accent-purple); }

        .limit-count {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Menu */
        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--bg-card);
            cursor: pointer;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:active {
            background: var(--bg-card);
        }

        .menu-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .menu-text {
            flex: 1;
        }

        .menu-title {
            font-size: 14px;
            font-weight: 500;
        }

        .menu-subtitle {
            font-size: 11px;
            color: var(--text-muted);
        }

        .menu-arrow {
            color: var(--text-muted);
            font-size: 18px;
        }

        /* ========== LOADING ========== */
        .loader-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            gap: 16px;
        }

        .loader-ring {
            width: 44px;
            height: 44px;
            border: 3px solid var(--bg-card);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-text {
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-primary);
            border: 1px solid var(--bg-card);
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 13px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 200;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Footer */
        .app-footer {
            text-align: center;
            padding: 20px 16px;
            color: var(--text-muted);
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- Onboarding -->
    <div id="onboarding" class="onboarding" style="display: flex;">
        <div class="onboarding-slides" id="slides">
            <div class="onboarding-slide">
                <div class="onboarding-icon">üì•</div>
                <h2 class="onboarding-title">Descarga contenido</h2>
                <p class="onboarding-desc">Descarga videos, fotos, m√∫sica y archivos de cualquier canal de Telegram</p>
            </div>
            <div class="onboarding-slide">
                <div class="onboarding-icon">üîó</div>
                <h2 class="onboarding-title">Solo pega el enlace</h2>
                <p class="onboarding-desc">Copia cualquier enlace t.me/ y p√©galo aqu√≠. ¬°Es as√≠ de f√°cil!</p>
            </div>
            <div class="onboarding-slide">
                <div class="onboarding-icon">‚≠ê</div>
                <h2 class="onboarding-title">Hazte Premium</h2>
                <p class="onboarding-desc">Desbloquea descargas ilimitadas, m√∫sica, APKs y mucho m√°s</p>
            </div>
        </div>
        <div class="onboarding-footer">
            <div class="onboarding-dots">
                <div class="dot active" data-slide="0"></div>
                <div class="dot" data-slide="1"></div>
                <div class="dot" data-slide="2"></div>
            </div>
            <button class="onboarding-btn" id="onboardingBtn">Siguiente</button>
            <button class="onboarding-skip" id="skipBtn">Omitir</button>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loader-screen">
        <div class="loader-ring"></div>
        <p class="loader-text">Cargando...</p>
    </div>

    <!-- App -->
    <div id="app" class="container" style="display: none;">
        
        <!-- Header -->
        <div class="app-header">
            <div class="app-brand">
                <div class="app-logo">üì•</div>
                <div>
                    <div class="app-title">Bot de Descargas</div>
                    <div class="app-subtitle" id="userPlan">Plan Free</div>
                </div>
            </div>
            <div class="user-avatar" id="userAvatar" onclick="switchTab('account')">U</div>
        </div>

        <!-- ==================== TAB: INICIO ==================== -->
        <div id="tab-home" class="tab-panel active">
            
            <!-- Welcome -->
            <div class="welcome-banner" id="welcomeBanner">
                <div class="welcome-emoji">üëã</div>
                <div class="welcome-text" id="welcomeText">¬°Hola!</div>
                <div class="welcome-hint">Pega un enlace de Telegram para descargar</div>
            </div>

            <!-- Download Box -->
            <div class="card">
                <div class="card-body">
                    <div class="download-box">
                        <input type="text" class="download-input" id="linkInput" 
                               placeholder="Pega el enlace t.me/ aqu√≠..."
                               autocomplete="off">
                        <button class="download-btn" id="downloadBtn" onclick="startDownload()">
                            ‚û§
                        </button>
                    </div>
                    <div class="download-status" id="downloadStatus">
                        <span id="statusIcon">‚è≥</span>
                        <span id="statusText">Procesando...</span>
                    </div>
                    <div class="action-btns">
                        <button class="action-btn" onclick="pasteFromClipboard()">
                            üìã Pegar
                        </button>
                        <button class="action-btn" onclick="showHelp()">
                            ‚ùì Ayuda
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Hoy</span>
                </div>
                <div class="card-body">
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-icon">üé¨</div>
                            <div class="quick-stat-value" id="todayVideos">0</div>
                            <div class="quick-stat-label">Videos</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-icon">üì∏</div>
                            <div class="quick-stat-value" id="todayPhotos">0</div>
                            <div class="quick-stat-label">Fotos</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-icon">üéµ</div>
                            <div class="quick-stat-value" id="todayMusic">0</div>
                            <div class="quick-stat-label">M√∫sica</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-icon">üì±</div>
                            <div class="quick-stat-value" id="todayApk">0</div>
                            <div class="quick-stat-label">APKs</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Premium Mini Banner (only for free users) -->
            <div class="premium-mini" id="premiumBanner" onclick="switchTab('premium')">
                <span class="premium-mini-icon">‚≠ê</span>
                <div class="premium-mini-text">
                    <div class="premium-mini-title">¬°Hazte Premium!</div>
                    <div class="premium-mini-desc">Desbloquea todo por solo 199 ‚≠ê</div>
                </div>
                <span class="premium-mini-arrow">‚Ä∫</span>
            </div>

        </div>

        <!-- ==================== TAB: PREMIUM ==================== -->
        <div id="tab-premium" class="tab-panel">
            
            <!-- Si ya es premium -->
            <div id="premiumActive" style="display: none;">
                <div class="premium-active">
                    <div class="premium-active-badge">üëë Premium Activo</div>
                    <div class="premium-active-days" id="daysLeft">0</div>
                    <div class="premium-active-text">d√≠as restantes</div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <button class="buy-button" onclick="buyPremium()">
                            ‚≠ê Extender Premium
                        </button>
                    </div>
                </div>
            </div>

            <!-- Si no es premium -->
            <div id="premiumOffer">
                <div class="premium-hero">
                    <div class="premium-crown">‚≠ê</div>
                    <h2 class="premium-title">Elige tu Plan Premium</h2>
                    <p class="premium-desc">4 opciones para ti</p>
                </div>

                <!-- Bonus Referidos -->
                <div class="referral-bonus-card">
                    <div style="font-size: 40px; margin-bottom: 12px;">üéÅ</div>
                    <div style="font-size: 16px; font-weight: 700; margin-bottom: 6px;">BONUS REFERIDOS GRATIS</div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                        15 referidos confirmados = <span style="color: var(--accent-green); font-weight: 700;">+1 d√≠a Premium</span><br>
                        M√°ximo acumulable: 15 d√≠as
                    </div>
                    <button class="referral-bonus-btn" onclick="switchTab('referrals')">
                        üë• Ver Mis Referidos
                    </button>
                </div>

                <!-- Plan 1: Prueba -->
                <div class="plan-card">
                    <div class="card-body">
                        <div class="plan-header">
                            <div class="plan-info">
                                <div style="font-size: 12px; color: var(--accent-purple); font-weight: 700; margin-bottom: 4px; letter-spacing: 0.5px;">‚ú® PRUEBA</div>
                                <h3>üéÅ Prueba</h3>
                                <p class="plan-desc">Perfecto para probar (8.3‚≠ê/d√≠a)</p>
                            </div>
                            <div class="plan-price">
                                <div class="plan-price-main" style="color: var(--accent-blue);">
                                    25 <span class="plan-price-star">‚≠ê</span>
                                </div>
                                <div class="plan-price-sub">3 d√≠as ¬∑ ~$0.25</div>
                            </div>
                        </div>
                        <button class="buy-button" onclick="buyPremium('trial')">
                            ‚≠ê Obtener Prueba
                        </button>
                    </div>
                </div>

                <!-- Plan 2: Semanal (M√ÅS POPULAR) -->
                <div class="plan-card featured" style="border-color: var(--accent-blue); position: relative;">
                    <div class="plan-badge" style="background: var(--accent-blue);">
                        üî• M√ÅS POPULAR
                    </div>
                    <div class="card-body" style="padding-top: 24px;">
                        <div class="plan-header">
                            <div class="plan-info">
                                <h3>üî• Semanal</h3>
                                <p class="plan-desc">Mejor precio/d√≠a (10.7‚≠ê/d√≠a)</p>
                            </div>
                            <div class="plan-price">
                                <div class="plan-price-main" style="color: var(--accent-blue);">
                                    75 <span class="plan-price-star">‚≠ê</span>
                                </div>
                                <div class="plan-price-sub">7 d√≠as ¬∑ ~$0.75</div>
                            </div>
                        </div>
                        <button class="buy-button" style="background: linear-gradient(135deg, var(--accent-blue), #1E96D1);" onclick="buyPremium('weekly')">
                            üî• Obtener Semanal
                        </button>
                    </div>
                </div>

                <!-- Plan 3: Mensual (RECOMENDADO) -->
                <div class="plan-card featured" style="border-color: var(--accent-green); position: relative;">
                    <div class="plan-badge" style="background: var(--accent-green);">
                        ‚≠ê RECOMENDADO
                    </div>
                    <div class="card-body" style="padding-top: 24px;">
                        <div class="plan-header">
                            <div class="plan-info">
                                <h3>üíé Mensual</h3>
                                <p class="plan-desc">El m√°s elegido (5.0‚≠ê/d√≠a)</p>
                            </div>
                            <div class="plan-price">
                                <div class="plan-price-main" style="color: var(--accent-green);">
                                    149 <span class="plan-price-star">‚≠ê</span>
                                </div>
                                <div class="plan-price-sub">30 d√≠as ¬∑ ~$1.49</div>
                            </div>
                        </div>
                        <button class="buy-button" style="background: linear-gradient(135deg, var(--accent-green), #5BB05B);" onclick="buyPremium('monthly')">
                            üíé Obtener Mensual
                        </button>
                    </div>
                </div>

                <!-- Plan 4: Trimestral (MEJOR VALOR) -->
                <div class="plan-card featured" style="border-color: var(--accent-orange); position: relative;">
                    <div class="plan-badge" style="background: var(--accent-orange);">
                        üí∞ MEJOR VALOR
                    </div>
                    <div class="card-body" style="padding-top: 24px;">
                        <div class="plan-header">
                            <div class="plan-info">
                                <h3>üëë Trimestral</h3>
                                <p class="plan-desc">Ahorra 11% (4.4‚≠ê/d√≠a)</p>
                            </div>
                            <div class="plan-price">
                                <div class="plan-price-main" style="color: var(--accent-orange);">
                                    399 <span class="plan-price-star">‚≠ê</span>
                                </div>
                                <div class="plan-price-sub">90 d√≠as ¬∑ ~$3.99</div>
                            </div>
                        </div>
                        <div class="plan-savings">
                            <span style="font-size: 12px; color: var(--accent-orange); font-weight: 700;">üí∞ AHORRAS 48‚≠ê vs 3 meses separados</span>
                        </div>
                        <button class="buy-button" style="background: linear-gradient(135deg, var(--accent-orange), #D89640);" onclick="buyPremium('quarterly')">
                            üëë Obtener Trimestral
                        </button>
                    </div>
                </div>

                <!-- Comparativa de beneficios -->
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <span class="card-title">‚ú® Beneficios Premium</span>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: 24px;">üì∏</div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600;">Fotos Ilimitadas</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Descarga todas las que quieras</div>
                            </div>
                            <div style="color: var(--accent-green); font-weight: 600;">‚àû</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: 24px;">üé¨</div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600;">50 Videos/d√≠a</div>
                                <div style="font-size: 11px; color: var(--text-muted);">vs 3 en plan gratuito</div>
                            </div>
                            <div style="color: var(--accent-green); font-weight: 600;">50</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div style="font-size: 24px;">üéµ</div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600;">50 Canciones/d√≠a</div>
                                <div style="font-size: 11px; color: var(--text-muted);">M√∫sica sin l√≠mites</div>
                            </div>
                            <div style="color: var(--accent-green); font-weight: 600;">50</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0;">
                            <div style="font-size: 24px;">üö´</div>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 600;">Sin Anuncios</div>
                                <div style="font-size: 11px; color: var(--text-muted);">Experiencia premium</div>
                            </div>
                            <div style="color: var(--accent-green); font-weight: 600;">‚úì</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB: CUENTA ==================== -->
        <div id="tab-account" class="tab-panel">
            
            <!-- Connection Status -->
            <div class="card">
                <div class="account-card">
                    <div class="account-icon" id="connectionIcon">üîó</div>
                    <div class="account-info">
                        <h3 id="connectionTitle">Estado de conexi√≥n</h3>
                        <p id="connectionText">Verificando...</p>
                    </div>
                </div>
                <div class="card-body" style="padding-top: 0;">
                    <button class="account-btn primary" id="connectBtn" onclick="configureAccount()">
                        ‚öôÔ∏è Configurar cuenta
                    </button>
                </div>
            </div>

            <!-- Limits -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä L√≠mites de hoy</span>
                    <span id="planBadge" style="font-size: 11px; color: var(--accent-blue);">FREE</span>
                </div>
                <div class="card-body">
                    <div class="limit-item">
                        <div class="limit-icon">üé¨</div>
                        <div class="limit-info">
                            <div class="limit-name">Videos</div>
                            <div class="limit-bar">
                                <div class="limit-fill blue" id="limitVideo" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="limit-count" id="countVideo">0/3</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-icon">üì∏</div>
                        <div class="limit-info">
                            <div class="limit-name">Fotos</div>
                            <div class="limit-bar">
                                <div class="limit-fill green" id="limitPhoto" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="limit-count" id="countPhoto">0/10</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-icon">üéµ</div>
                        <div class="limit-info">
                            <div class="limit-name">M√∫sica</div>
                            <div class="limit-bar">
                                <div class="limit-fill orange" id="limitMusic" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="limit-count" id="countMusic">üîí</div>
                    </div>
                    <div class="limit-item">
                        <div class="limit-icon">üì±</div>
                        <div class="limit-info">
                            <div class="limit-name">APKs</div>
                            <div class="limit-bar">
                                <div class="limit-fill purple" id="limitApk" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="limit-count" id="countApk">üîí</div>
                    </div>
                </div>
            </div>

            <!-- Menu -->
            <div class="card">
                <div class="menu-item" onclick="switchTab('premium')">
                    <div class="menu-icon">‚≠ê</div>
                    <div class="menu-text">
                        <div class="menu-title">Premium</div>
                        <div class="menu-subtitle" id="premiumStatus">Ver planes</div>
                    </div>
                    <span class="menu-arrow">‚Ä∫</span>
                </div>
                <div class="menu-item" onclick="openSupport()">
                    <div class="menu-icon">üí¨</div>
                    <div class="menu-text">
                        <div class="menu-title">Soporte</div>
                        <div class="menu-subtitle">¬øNecesitas ayuda?</div>
                    </div>
                    <span class="menu-arrow">‚Ä∫</span>
                </div>
            </div>

            <div class="app-footer">
                Bot de Descargas v3.0<br>
                Hecho con ‚ù§Ô∏è
            </div>
        </div>

        <!-- ==================== TAB: REFERIDOS ==================== -->
        <div id="tab-referrals" class="tab-panel">
            
            <!-- Header -->
            <div class="card">
                <div class="card-body" style="text-align: center; padding: 24px;">
                    <div style="font-size: 56px; margin-bottom: 12px;">üë•</div>
                    <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 6px;">Sistema de Referidos</h2>
                    <p style="font-size: 13px; color: var(--text-muted);">Invita amigos y gana Premium gratis</p>
                </div>
            </div>

            <!-- Progreso -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Tu Progreso</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div style="background: rgba(42, 171, 238, 0.1); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);" id="confirmedReferrals">0</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Confirmados</div>
                        </div>
                        <div style="background: rgba(229, 165, 88, 0.1); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: var(--accent-orange);" id="pendingReferrals">0</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Pendientes</div>
                        </div>
                    </div>

                    <!-- Barra de progreso -->
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); margin-bottom: 6px;">
                            <span>Progreso hacia recompensa</span>
                            <span id="progressText">0/15</span>
                        </div>
                        <div style="background: var(--bg-card); height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>

                    <!-- D√≠as ganados -->
                    <div style="background: rgba(109, 194, 109, 0.1); padding: 14px; border-radius: 10px; margin-top: 12px; text-align: center;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">üéÅ D√≠as Premium Ganados</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);" id="daysEarned">0</div>
                    </div>
                </div>
            </div>

            <!-- C√≥mo funciona -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üéØ C√≥mo Funciona</span>
                </div>
                <div class="card-body">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(42, 171, 238, 0.15); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">1Ô∏è‚É£</div>
                        <div style="font-size: 13px; line-height: 1.5;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Comparte tu enlace</div>
                            <div style="color: var(--text-muted);">Invita a tus amigos a usar el bot</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(42, 171, 238, 0.15); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">2Ô∏è‚É£</div>
                        <div style="font-size: 13px; line-height: 1.5;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Ellos usan el bot</div>
                            <div style="color: var(--text-muted);">Deben conectar su cuenta y hacer 1 descarga</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(42, 171, 238, 0.15); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;">3Ô∏è‚É£</div>
                        <div style="font-size: 13px; line-height: 1.5;">
                            <div style="font-weight: 600; margin-bottom: 2px;">Ganas recompensas</div>
                            <div style="color: var(--text-muted);">Cada 15 referidos = 1 d√≠a Premium (m√°x. 15 d√≠as)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tu enlace -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üîó Tu Enlace Personal</span>
                </div>
                <div class="card-body">
                    <div style="background: var(--bg-input); padding: 14px; border-radius: 10px; margin-bottom: 12px; word-break: break-all; font-size: 12px; font-family: 'Courier New', monospace; color: var(--accent-blue);" id="referralLink">
                        Cargando...
                    </div>
                    <button class="account-btn primary" onclick="copyReferralLink()">
                        üìã Copiar Enlace
                    </button>
                    <button class="account-btn" style="background: rgba(42, 171, 238, 0.1); color: var(--accent-blue); margin-top: 8px;" onclick="shareReferralLink()">
                        üì§ Compartir
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav" style="display: none;">
        <button class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            <span>Inicio</span>
        </button>
        <button class="nav-item" onclick="switchTab('premium')">
            <span class="nav-icon">‚≠ê</span>
            <span>Premium</span>
        </button>
        <button class="nav-item" onclick="switchTab('referrals')">
            <span class="nav-icon">üë•</span>
            <span>Referir</span>
        </button>
        <button class="nav-item" onclick="switchTab('account')">
            <span class="nav-icon">üë§</span>
            <span>Cuenta</span>
        </button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        if (tg.setHeaderColor) tg.setHeaderColor('#17212B');
        if (tg.setBackgroundColor) tg.setBackgroundColor('#17212B');

        const API_BASE = window.location.origin;
        let userData = null;
        let isConnected = false;
        let currentSlide = 0;

        // ========== ONBOARDING ==========
        function checkOnboarding() {
            try {
                const seen = localStorage.getItem('onboarding_seen');
                const onboardingEl = document.getElementById('onboarding');
                const loadingEl = document.getElementById('loading');
                
                console.log('checkOnboarding called, seen:', seen);
                
                if (seen === 'true') {
                    console.log('Onboarding ya visto, ocultando...');
                    onboardingEl.style.display = 'none';
                    loadingEl.style.display = 'flex';
                    loadUserData();
                } else {
                    console.log('Primera vez o no visto, mostrando onboarding');
                    onboardingEl.style.display = 'flex';
                    loadingEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking onboarding:', error);
                // Si falla, mostrar onboarding por seguridad
                document.getElementById('onboarding').style.display = 'flex';
                document.getElementById('loading').style.display = 'none';
            }
        }

        function nextSlide() {
            const slides = document.getElementById('slides');
            const dots = document.querySelectorAll('.dot');
            const btn = document.getElementById('onboardingBtn');
            
            currentSlide++;
            
            if (currentSlide >= 3) {
                finishOnboarding();
                return;
            }
            
            slides.style.transform = `translateX(-${currentSlide * 100}%)`;
            dots.forEach((d, i) => d.classList.toggle('active', i === currentSlide));
            
            if (currentSlide === 2) {
                btn.textContent = '¬°Empezar!';
            }
        }

        function finishOnboarding() {
            try {
                localStorage.setItem('onboarding_seen', 'true');
                console.log('Onboarding completado y guardado');
            } catch (error) {
                console.error('Error saving onboarding state:', error);
            }
            
            document.getElementById('onboarding').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            loadUserData();
        }

        document.getElementById('onboardingBtn')?.addEventListener('click', nextSlide);
        document.getElementById('skipBtn')?.addEventListener('click', finishOnboarding);

        // ========== NAVIGATION ==========
        function switchTab(tabId) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabId}')"]`)?.classList.add('active');
            
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        // ========== TOAST ==========
        function showToast(message, duration = 2500) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // ========== LOAD USER DATA ==========
        async function loadUserData() {
            try {
                const response = await fetch(`${API_BASE}/api/miniapp/user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData || '',
                        user: tg.initDataUnsafe?.user || {}
                    })
                });
                if (response.ok) {
                    userData = await response.json();
                }
            } catch (e) {
                console.error(e);
            }

            // Fallback data
            if (!userData) {
                userData = {
                    user_id: tg.initDataUnsafe?.user?.id || 12345,
                    first_name: tg.initDataUnsafe?.user?.first_name || 'Usuario',
                    premium: false,
                    premium_until: null,
                    has_session: false,
                    daily_video: 0,
                    daily_photo: 0,
                    daily_music: 0,
                    daily_apk: 0,
                    limits: {
                        video: { used: 0, max: 3 },
                        photo: { used: 0, max: 10 },
                        music: { used: 0, max: 0 },
                        apk: { used: 0, max: 0 }
                    }
                };
            }

            updateUI();
        }

        // ========== UPDATE UI ==========
        function updateUI() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'flex';

            // User info
            const name = userData.first_name || 'Usuario';
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            document.getElementById('welcomeText').textContent = `¬°Hola, ${name}!`;
            
            // Cargar stats de referidos autom√°ticamente
            loadReferralStats();
            
            // Plan
            if (userData.premium) {
                document.getElementById('userPlan').textContent = 'Plan Premium ‚≠ê';
                document.getElementById('planBadge').textContent = 'PREMIUM';
                document.getElementById('planBadge').style.color = '#E5A958';
                document.getElementById('premiumStatus').textContent = 'Activo';
                document.getElementById('premiumBanner').style.display = 'none';
                
                document.getElementById('premiumActive').style.display = 'block';
                document.getElementById('premiumOffer').style.display = 'none';
                
                if (userData.premium_until) {
                    const days = Math.ceil((new Date(userData.premium_until) - new Date()) / (1000*60*60*24));
                    document.getElementById('daysLeft').textContent = Math.max(0, days);
                }
            } else {
                document.getElementById('userPlan').textContent = 'Plan Free';
                document.getElementById('planBadge').textContent = 'FREE';
                document.getElementById('premiumStatus').textContent = 'Ver planes';
                document.getElementById('premiumBanner').style.display = 'flex';
                document.getElementById('premiumActive').style.display = 'none';
                document.getElementById('premiumOffer').style.display = 'block';
            }

            // Quick Stats
            document.getElementById('todayVideos').textContent = userData.daily_video || 0;
            document.getElementById('todayPhotos').textContent = userData.daily_photo || 0;
            document.getElementById('todayMusic').textContent = userData.daily_music || 0;
            document.getElementById('todayApk').textContent = userData.daily_apk || 0;

            // Limits
            const limits = userData.limits || {};
            updateLimit('Video', limits.video || {used: 0, max: 3});
            updateLimit('Photo', limits.photo || {used: 0, max: 10});
            updateLimit('Music', limits.music || {used: 0, max: 0});
            updateLimit('Apk', limits.apk || {used: 0, max: 0});

            // Connection status
            isConnected = userData.has_session || false;
            updateConnectionStatus();
        }

        function updateLimit(type, data) {
            const countEl = document.getElementById('count' + type);
            const limitEl = document.getElementById('limit' + type);
            
            if (data.max === 0) {
                countEl.textContent = 'üîí';
                limitEl.style.width = '0%';
            } else if (data.max === 999) {
                countEl.textContent = `${data.used}/‚àû`;
                limitEl.style.width = '10%';
            } else {
                countEl.textContent = `${data.used}/${data.max}`;
                limitEl.style.width = Math.min((data.used / data.max) * 100, 100) + '%';
            }
        }

        function updateConnectionStatus() {
            const icon = document.getElementById('connectionIcon');
            const title = document.getElementById('connectionTitle');
            const text = document.getElementById('connectionText');
            const btn = document.getElementById('connectBtn');

            if (isConnected) {
                icon.className = 'account-icon connected';
                icon.textContent = '‚úÖ';
                title.textContent = 'Cuenta conectada';
                text.textContent = 'Puedes descargar contenido';
                btn.textContent = 'üîå Desconectar cuenta';
                btn.className = 'account-btn danger';
                btn.onclick = disconnectAccount;
            } else {
                icon.className = 'account-icon disconnected';
                icon.textContent = '‚ö†Ô∏è';
                title.textContent = 'Cuenta no conectada';
                text.textContent = 'Configura tu cuenta para descargar';
                btn.textContent = '‚öôÔ∏è Configurar cuenta';
                btn.className = 'account-btn primary';
                btn.onclick = configureAccount;
            }
        }

        // ========== DOWNLOAD ==========
        async function startDownload() {
            const input = document.getElementById('linkInput');
            const btn = document.getElementById('downloadBtn');
            const status = document.getElementById('downloadStatus');
            const link = input.value.trim();

            if (!link) {
                showToast('Pega un enlace de Telegram');
                return;
            }

            if (!link.includes('t.me/')) {
                showToast('Enlace no v√°lido');
                return;
            }

            if (!isConnected) {
                status.className = 'download-status show error';
                document.getElementById('statusIcon').textContent = '‚ö†Ô∏è';
                document.getElementById('statusText').textContent = 'Configura tu cuenta primero';
                return;
            }

            btn.disabled = true;
            status.className = 'download-status show loading';
            document.getElementById('statusIcon').textContent = '‚è≥';
            document.getElementById('statusText').textContent = 'Procesando descarga...';

            try {
                const response = await fetch(`${API_BASE}/api/miniapp/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userData?.user_id || tg.initDataUnsafe?.user?.id,
                        link: link
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    status.className = 'download-status show success';
                    document.getElementById('statusIcon').textContent = '‚úÖ';
                    document.getElementById('statusText').textContent = 'Revisa el chat del bot';
                    input.value = '';
                    if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                } else if (result.error === 'no_session') {
                    status.className = 'download-status show error';
                    document.getElementById('statusIcon').textContent = '‚ö†Ô∏è';
                    document.getElementById('statusText').textContent = result.message;
                } else {
                    throw new Error(result.error || 'Error');
                }
            } catch (e) {
                status.className = 'download-status show error';
                document.getElementById('statusIcon').textContent = '‚ùå';
                document.getElementById('statusText').textContent = 'Error al procesar';
            }
            
            btn.disabled = false;
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('linkInput').value = text;
                showToast('Enlace pegado');
            } catch (e) {
                showToast('No se pudo acceder al portapapeles');
            }
        }

        function showHelp() {
            tg.showAlert(
                'üìå Formatos v√°lidos:\n\n' +
                '‚Ä¢ t.me/canal/123\n' +
                '‚Ä¢ t.me/c/123456/789\n' +
                '‚Ä¢ t.me/+ABC123/456\n\n' +
                'Copia el enlace desde Telegram y p√©galo aqu√≠.'
            );
        }

        // ========== ACCOUNT ==========
        async function configureAccount() {
            showToast('Enviando instrucciones...');
            
            try {
                const response = await fetch(`${API_BASE}/api/miniapp/configure`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userData?.user_id || tg.initDataUnsafe?.user?.id
                    })
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    tg.showAlert('üì± Revisa el chat del bot para configurar tu cuenta');
                    setTimeout(() => tg.close(), 1500);
                } else {
                    showToast('Error al enviar');
                }
            } catch (e) {
                showToast('Error de conexi√≥n');
            }
        }

        async function disconnectAccount() {
            tg.showConfirm('¬øDesconectar tu cuenta?', async (confirmed) => {
                if (confirmed) {
                    showToast('Desconectando...');
                    
                    try {
                        const response = await fetch(`${API_BASE}/api/miniapp/disconnect`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: userData?.user_id || tg.initDataUnsafe?.user?.id
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.ok) {
                            tg.showAlert('‚úÖ Cuenta desconectada. La MiniApp se actualizar√°.');
                            isConnected = false;
                            updateConnectionStatus();
                            // Forzar recarga de datos
                            setTimeout(loadUserData, 1000);
                        } else {
                            showToast(result.message || 'Error');
                        }
                    } catch (e) {
                        showToast('Error de conexi√≥n');
                    }
                }
            });
        }

        function openSupport() {
            tg.openTelegramLink('https://t.me/observer_bots/11');
        }

        // ========== PREMIUM ==========
        async function buyPremium(planKey = 'monthly') {
            showToast('Preparando pago...');

            // Plan details
            const plans = {
                'trial': { stars: 25, days: 3, name: 'üéÅ Prueba' },
                'weekly': { stars: 75, days: 7, name: 'üî• Semanal' },
                'monthly': { stars: 149, days: 30, name: 'üíé Mensual' },
                'quarterly': { stars: 399, days: 90, name: 'üëë Trimestral' }
            };

            const plan = plans[planKey] || plans['monthly'];

            try {
                const response = await fetch(`${API_BASE}/api/miniapp/create-invoice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userData?.user_id || tg.initDataUnsafe?.user?.id,
                        plan_key: planKey
                    })
                });

                const result = await response.json();

                if (result.ok && result.invoice_link) {
                    tg.openInvoice(result.invoice_link, (status) => {
                        if (status === 'paid') {
                            tg.showAlert(`¬°Gracias! Tu Premium ${plan.name} se activar√° en segundos ‚ú®`);
                            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                            setTimeout(() => {
                                loadUserData();
                                tg.close();
                            }, 2000);
                        } else if (status === 'cancelled') {
                            showToast('Pago cancelado');
                        } else if (status === 'failed') {
                            showToast('Error en el pago');
                        }
                        if (btn) btn.disabled = false;
                    });
                } else {
                    throw new Error(result.error || 'Error al crear factura');
                }
            } catch (e) {
                console.error(e);
                showToast('Error al procesar el pago');
                if (btn) btn.disabled = false;
            }
        }

        // ========== REFERRALS ==========
        let referralData = null;

        async function loadReferralStats() {
            try {
                const userId = userData?.user_id || tg.initDataUnsafe?.user?.id;
                
                if (!userId) {
                    console.error('No user ID available');
                    return false;
                }
                
                const response = await fetch(`${API_BASE}/api/miniapp/referrals?user_id=${userId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.ok) {
                        referralData = result;
                        updateReferralUI();
                        return true;
                    } else {
                        console.error('API returned error:', result);
                        return false;
                    }
                } else {
                    console.error('HTTP error:', response.status);
                    return false;
                }
            } catch (e) {
                console.error('Error loading referral stats:', e);
                return false;
            }
        }

        function updateReferralUI() {
            if (!referralData) return;
            
            const stats = referralData.stats;
            
            // Actualizar n√∫meros
            document.getElementById('confirmedReferrals').textContent = stats.confirmed || 0;
            document.getElementById('pendingReferrals').textContent = stats.pending || 0;
            document.getElementById('daysEarned').textContent = stats.days_earned || 0;
            document.getElementById('progressText').textContent = `${stats.progress || 0}/${stats.next_reward_at || 15}`;
            
            // Actualizar barra de progreso
            const progressPercent = ((stats.progress || 0) / (stats.next_reward_at || 15)) * 100;
            document.getElementById('progressBar').style.width = `${Math.min(progressPercent, 100)}%`;
            
            // Actualizar enlace
            document.getElementById('referralLink').textContent = referralData.referral_link;
        }

        async function copyReferralLink() {
            if (!referralData || !referralData.referral_link) {
                showToast('Cargando enlace...');
                const success = await loadReferralStats();
                if (!success || !referralData || !referralData.referral_link) {
                    showToast('‚ùå Error al generar enlace');
                    console.error('Failed to load referral data');
                    return;
                }
            }
            
            try {
                await navigator.clipboard.writeText(referralData.referral_link);
                showToast('‚úÖ Enlace copiado');
                if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            } catch (e) {
                console.error('Clipboard error:', e);
                showToast('‚ùå Error al copiar');
            }
        }

        async function shareReferralLink() {
            if (!referralData || !referralData.referral_link) {
                showToast('Cargando enlace...');
                const success = await loadReferralStats();
                if (!success || !referralData || !referralData.referral_link) {
                    showToast('‚ùå Error al generar enlace');
                    console.error('Failed to load referral data');
                    return;
                }
            }
            
            const text = `¬°Descarga contenido de Telegram con este bot! üöÄ\n\n${referralData.referral_link}`;
            
            if (tg.openTelegramLink) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(referralData.referral_link)}&text=${encodeURIComponent('¬°Descarga contenido de Telegram con este bot! üöÄ')}`);
            } else {
                await copyReferralLink();
            }
        }

        // ========== INIT ==========
        // Ejecutar inmediatamente cuando el script se carga
        (function() {
            console.log('=== INIT MINIAPP ===');
            console.log('ReadyState:', document.readyState);
            
            // Si el DOM ya est√° listo, ejecutar inmediatamente
            if (document.readyState !== 'loading') {
                console.log('DOM ya listo, ejecutando checkOnboarding...');
                checkOnboarding();
            } else {
                // Esperar a que el DOM est√© listo
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOMContentLoaded fired, ejecutando checkOnboarding...');
                    checkOnboarding();
                });
            }
        })();

        // Cargar stats de referidos al cambiar a la pesta√±a
        const originalSwitchTab = switchTab;
        switchTab = function(tabId) {
            originalSwitchTab(tabId);
            if (tabId === 'referrals' && !referralData) {
                loadReferralStats();
            }
        };

        // Enter key to download
        document.getElementById('linkInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startDownload();
        });
    </script>
</body>
</html>